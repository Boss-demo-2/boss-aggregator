name: BOSS Aggregator

on:
  schedule:
    - cron: "0 10 * * 2,4"   # 10 AM UTC every Tuesday and Thursday
  workflow_dispatch:           # Manual trigger — use this for the demo

jobs:
  aggregate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout boss-aggregator
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Run aggregation script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/aggregate.js

      - name: Commit updated version.json
        run: |
          git config user.name "boss-aggregator-bot"
          git config user.email "bot@boss.com"
          git add version.json
          git diff --staged --quiet || git commit -m "chore: update BOSS version [skip ci]"
          git push

      - name: Create GitHub Release for BOSS version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(node -e "console.log(require('./version.json').bossVersion)")
          PREV=$(node -e "console.log(require('./version.json').previousVersion)")
          BUMP=$(node -e "console.log(require('./version.json').bumpType)")
          REASON=$(node -e "console.log(require('./version.json').bumpReason)")
          SERVICES=$(node -e "console.log(JSON.stringify(require('./version.json').services, null, 2))")
          
          # Only create a new release if version actually changed
          if [ "$VERSION" != "$PREV" ]; then
            NOTES="## BOSS v${VERSION}

**Bump Type:** ${BUMP}
**Previous Version:** ${PREV}
**Reason:** ${REASON}

### Service Manifest
\`\`\`json
${SERVICES}
\`\`\`

*Auto-generated by BOSS Aggregator on $(date -u)*"
            
            gh release create "v${VERSION}" \
              --title "BOSS v${VERSION}" \
              --notes "${NOTES}" \
              --latest
            echo "✅ BOSS Release v${VERSION} created"
          else
            echo "ℹ No version change — skipping release creation"
          fi
