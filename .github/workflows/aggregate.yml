name: BOSS Aggregator

on:
  schedule:
    - cron: "0 10 * * 2,4"
  workflow_dispatch:

jobs:
  aggregate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout boss-aggregator
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Run aggregation script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/aggregate.js

      - name: Commit updated version.json
        run: |
          git config user.name "boss-aggregator-bot"
          git config user.email "bot@boss.com"
          git add version.json
          git diff --staged --quiet || git commit -m "chore: update BOSS version [skip ci]"
          git push

      - name: Create GitHub Release via API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(node -e "console.log(require('./version.json').bossVersion)")
          PREV=$(node -e "console.log(require('./version.json').previousVersion)")
          BUMP=$(node -e "console.log(require('./version.json').bumpType)")

          if [ "$VERSION" != "$PREV" ]; then
            BODY="BOSS v${VERSION} | Bump: ${BUMP} | Previous: ${PREV}"
            curl -s -X POST \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/releases \
              -d "{\"tag_name\":\"v${VERSION}\",\"name\":\"BOSS v${VERSION}\",\"body\":\"${BODY}\",\"draft\":false,\"prerelease\":false}"
            echo "BOSS Release v${VERSION} created"
          else
            echo "No version change - skipping release"
          fi
